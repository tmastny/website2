---
title: 'Tuning and Cross-validation with tidymodels and scikit learn'
author: ~
date: '2020-06-30'
categories: []
tags: []
description:
draft: true
output:
  blogdown::html_page:
    toc: true
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE,
                      results='show', cache=FALSE, autodep=FALSE)
```

```{css, echo=FALSE}
body {
  max-width: 1000px;
}
```

## Introduction

[tidymodels](https://www.tidymodels.org/) is the new framework from
Max Kuhn, David Vaughan, and Julia Silge at RStudio. It's the successor to
the [caret](https://topepo.github.io/caret/) package, which was heavily
featured in Max Kuhn's book
[Applied Predictive Modeling](http://appliedpredictivemodeling.com/).

tidymodels promises a modular, extensible design for machine learning in R.
It also has a wonderful [website](https://www.tidymodels.org/) design
to help you get started as soon as possible, with a focus on examples and
case studies walking you through the components of the platform.

In this article, I want to translate concepts between tidymodels and
scikit-learn, Python's standard machine learning ecosystem. I hope this will
be useful for Python Data Scientists interested in R, and R users who want to
learn a little more about Python.

I'll cover the key machine learning workflows with scikit-learn and tidymodels
side-by-side, starting with preprocessing and feature engineering,
model tranining and cross-validation, as well as evaluation and comparison.

I think you'll find that while both frameworks have their own unique advantages,
there are many conceptual similarities that have helped me understand both
frameworks better.


## Comparisons

4 Tune Model Parameters 

tidymodels example.

<div class="row">
<div class="col-md-6">## tidymodels
```{r}
library(tidymodels)
library(modeldata)
library(vip)
library(readr)

# data(cells, package = "modeldata")
cells <- read_csv("cells.csv")
```
</div>
<div class="col-md-6">## sklearn
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>

We have to do a little preprocessing. All the features are numeric,
but the outcome is binary. R expects categorical outcomes as factors. 
With sklearn, we need to binarize it. 

<div class="row">
<div class="col-md-6">## tidymodels
```{r}
tree_rec <- recipe(class ~ ., data = cells) %>%
  step_rm(case) %>%
  step_string2factor(all_outcomes())
```
</div>
<div class="col-md-6">## sklearn
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>




<div class="row">
<div class="col-md-6">## tidymodels
```{r}
cell_split <- initial_split(
  cells,
  strata = class
)

cell_train <- training(cell_split)
cell_test <- testing(cell_split)
```
</div>
<div class="col-md-6">## sklearn
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>


<div class="row">
<div class="col-md-6">
```{r}
tree_model <- decision_tree(
  cost_complexity = tune(),
  tree_depth = tune()
) %>%
  set_engine("rpart") %>%
  set_mode("classification")
```
</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>

One advantage here is sensible defaults for tidymodel tuning grids. 
<div class="row">
<div class="col-md-6">
```{r}
tree_grid <- grid_regular(
  cost_complexity(),
  tree_depth(),
  levels = 5
)

tree_grid
```
</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>


<div class="row">
<div class="col-md-6">
```{r}
set.seed(234)
cell_folds <- vfold_cv(cell_train)
```
</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>


Both structures have a way to combine all the components of the model. 

<div class="row">
<div class="col-md-6">
```{r}
set.seed(345)

tree_wf <- workflow() %>%
  add_model(tree_model) %>%
  add_recipe(tree_rec)
```
</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>



Then to fit: 

Both structures have a way to combine all the components of the model. 

<div class="row">
<div class="col-md-6">
```{r}
tree_res <- tree_wf %>% 
  tune_grid(
    resamples = cell_folds,
    grid = tree_grid
  )
```
</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>



Get metrics

<div class="row">
<div class="col-md-6">
```{r}
best_param <- tree_res %>%
  select_best("roc_auc")

tree_res %>%
  show_best("roc_auc")
```

</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>

Variable importance

<div class="row">
<div class="col-md-6">
```{r}
best_tree <- tree_wf %>%
  finalize_workflow(best_param) %>%
  fit(data = cell_train)

best_tree %>%
  pull_workflow_fit() %>%
  vip()
```

</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>


Final validation

<div class="row">
<div class="col-md-6">
```{r}
best_tree %>%
  last_fit(cell_split) %>%
  collect_metrics()
```

</div>
<div class="col-md-6">
```{python, eval=FALSE}
import pandas as pd
import numpy as np

input_data = 's3://sagemaker-sample-data-us-east-2/processing/census/census-income.csv'
df = pd.read_csv(input_data, nrows=1000)
df.head()
```
</div>
</div>

```{r}
fs::dir_ls()
```
