---
title: 'emmeans for Better Contrasts in R'
author: ~
date: '2020-04-13'
slug: emmeans-how-contrasts-work-in-r
categories: []
tags: []
description: Using emmeans to find significant differences, without contrasts.
draft: true
output:
  blogdown::html_page:
    toc: true 
---


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#what-are-contrasts-when-to-use-emmeans"><del>What are contrasts?</del> When to use emmeans</a><ul>
<li><a href="#flight-data">Flight data</a></li>
</ul></li>
<li><a href="#mean-differences">Mean differences</a><ul>
<li><a href="#emmeans-mean-differences">emmeans mean differences</a></li>
</ul></li>
<li><a href="#ordered-and-time-factors">Ordered and time factors</a></li>
</ul>
</div>

<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>Forget everything you know about contrasts in R.
Which, if you are like me, that’s pretty easy. In my case,
contrasts were briefly mentioned in a stats class, and then I promptly
ignored them for years.</p>
<p>And I don’t really suggest you learn about contrasts.
There are many tutorials<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> explaining what contrasts are mathematically,
and how to set them in R.</p>
<p>But none of that is really useful to me.
For a long time, I didn’t get the point of contrasts.
And even when I did, using them in R was so cumbersome I basically gave up.</p>
<p>Enter <a href="https://cran.r-project.org/web/packages/emmeans/index.html"><code>emmeans</code></a>.
<code>emmeans</code> is an R package that super-powers <code>lm</code>, <code>glm</code>,
and the Bayesian friends in
<a href="https://github.com/paul-buerkner/brms"><code>brms</code></a> and
<a href="https://mc-stan.org/users/interfaces/rstanarm"><code>rstanarm</code></a>.</p>
<p>And you don’t have to learn (much) about contrasts to take advantage of it.</p>
</div>
<div id="what-are-contrasts-when-to-use-emmeans" class="section level2">
<h2><del>What are contrasts?</del> When to use emmeans</h2>
<p>I’m going to (almost) completely ignore what contrasts are.
Rather, I want to focus on how we can <em>use</em> contrasts (through emmeans)
by sharing some examples inspired by my work.</p>
<p>First, we’ll gather some data to work with.</p>
<div id="flight-data" class="section level3">
<h3>Flight data</h3>
<p>I’ll be sampling data from the <code>nycflights13</code> package,
using a hundred random rows from the top airlines.</p>
<pre class="r"><code>library(tidyverse, warn.conflicts = TRUE)
library(emmeans)
library(nycflights13)

set.seed(158)

flights &lt;- nycflights13::flights %&gt;%
  left_join(nycflights13::airlines)

top_carriers &lt;- flights %&gt;%
  count(name) %&gt;%
  slice_max(n, n = 5)

flights &lt;- flights %&gt;%
  filter(name %in% top_carriers$name) %&gt;%
  mutate(across(c(name, month), as.factor)) %&gt;%
  group_by(name) %&gt;%
  slice_sample(n = 100) %&gt;%
  ungroup()</code></pre>
</div>
</div>
<div id="mean-differences" class="section level2">
<h2>Mean differences</h2>
<p>Business example one: we are about air time and we want to understand
the differences in air time between carriers.</p>
<p>My first instinct is a summary:</p>
<pre class="r"><code>flights %&gt;%
  group_by(name) %&gt;%
  summarise(across(air_time, mean, na.rm = TRUE), n = n())</code></pre>
<pre><code>## # A tibble: 5 x 3
##   name                     air_time     n
## * &lt;fct&gt;                       &lt;dbl&gt; &lt;int&gt;
## 1 American Airlines Inc.      183.    100
## 2 Delta Air Lines Inc.        169.    100
## 3 ExpressJet Airlines Inc.     98.4   100
## 4 JetBlue Airways             167.    100
## 5 United Air Lines Inc.       206.    100</code></pre>
<p>And I also love box plots:</p>
<pre class="r"><code>flights %&gt;%
  ggplot(aes(fct_rev(name), air_time, group = name)) +
  geom_boxplot() +
  xlab(NULL) + 
  geom_hline(yintercept = mean(flights$air_time, na.rm = TRUE), color = &quot;blue&quot;) +
  coord_flip()</code></pre>
<p><img src="/blog/2020-04-13-how-contrasts-work-in-r_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Both of these explorations give us good indications there are some
real differences between air time in the top airlines.
But how can we be confident these are true differences,
and not due to chance? We need to do a statistical test.</p>
<p><strong>Put away your t tests</strong>.</p>
<blockquote>
<p><a href="https://lindeloev.github.io/tests-as-linear/">statistical tests are linear models</a></p>
</blockquote>
<p>So we’ll fit a linear model using the airlines as predictors.</p>
<pre class="r"><code>lm_airlines &lt;- lm(air_time ~ name, data = flights)
summary(lm_airlines)</code></pre>
<pre><code>## 
## Call:
## lm(formula = air_time ~ name, data = flights)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -170.36  -51.17  -15.44   33.35  434.64 
## 
## Coefficients:
##                              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                   183.093      8.371  21.873  &lt; 2e-16 ***
## nameDelta Air Lines Inc.      -13.941     11.778  -1.184   0.2371    
## nameExpressJet Airlines Inc.  -84.680     11.838  -7.153 3.13e-12 ***
## nameJetBlue Airways           -16.366     11.778  -1.390   0.1653    
## nameUnited Air Lines Inc.      23.267     11.749   1.980   0.0482 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 82.44 on 487 degrees of freedom
##   (8 observations deleted due to missingness)
## Multiple R-squared:  0.1609, Adjusted R-squared:  0.1541 
## F-statistic: 23.35 on 4 and 487 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>The classic <code>lm</code>-to-<code>summary</code> workflow.
Notice that <em>American Airlines Inc.</em> is no-where to be found.
That’s because it’s the “default” category.
R calls this contrast <code>treatment</code> but the more common name is dummy encoding.</p>
<p>All the other <code>name[Airline]</code> rows in the table show the estimated change
in air time from <em>American Airlines Inc.</em>, and how confident the model is
on that change based on the p-value.</p>
<p>So this tells us some nice stuff.
<em>ExpressJet Airlines Inc.</em> has much lower air time than American,
while United has a little more. But that’s it.</p>
<p>There are so many questions left unanswered:</p>
<ol style="list-style-type: decimal">
<li><p>Is the difference between Delta and JetBlue significant?</p></li>
<li><p>What about the difference between any pair?</p></li>
<li><p>How do any of them compare to the <em>average</em> air time?
Are some airlines much better or much worse?</p></li>
</ol>
<p><code>emmeans</code> has the answer.</p>
<div id="emmeans-mean-differences" class="section level3">
<h3>emmeans mean differences</h3>
<p>Find significant differences between every pair:</p>
<pre class="r"><code>lm_airlines %&gt;%
  emmeans(pairwise ~ name)</code></pre>
<pre><code>## $emmeans
##  name                     emmean   SE  df lower.CL upper.CL
##  American Airlines Inc.    183.1 8.37 487      167      200
##  Delta Air Lines Inc.      169.2 8.29 487      153      185
##  ExpressJet Airlines Inc.   98.4 8.37 487       82      115
##  JetBlue Airways           166.7 8.29 487      150      183
##  United Air Lines Inc.     206.4 8.24 487      190      223
## 
## Confidence level used: 0.95 
## 
## $contrasts
##  contrast                                          estimate   SE  df t.ratio
##  American Airlines Inc. - Delta Air Lines Inc.        13.94 11.8 487  1.184 
##  American Airlines Inc. - ExpressJet Airlines Inc.    84.68 11.8 487  7.153 
##  American Airlines Inc. - JetBlue Airways             16.37 11.8 487  1.390 
##  American Airlines Inc. - United Air Lines Inc.      -23.27 11.7 487 -1.980 
##  Delta Air Lines Inc. - ExpressJet Airlines Inc.      70.74 11.8 487  6.006 
##  Delta Air Lines Inc. - JetBlue Airways                2.42 11.7 487  0.207 
##  Delta Air Lines Inc. - United Air Lines Inc.        -37.21 11.7 487 -3.183 
##  ExpressJet Airlines Inc. - JetBlue Airways          -68.31 11.8 487 -5.800 
##  ExpressJet Airlines Inc. - United Air Lines Inc.   -107.95 11.7 487 -9.188 
##  JetBlue Airways - United Air Lines Inc.             -39.63 11.7 487 -3.391 
##  p.value
##  0.7608 
##  &lt;.0001 
##  0.6347 
##  0.2771 
##  &lt;.0001 
##  0.9996 
##  0.0134 
##  &lt;.0001 
##  &lt;.0001 
##  0.0067 
## 
## P value adjustment: tukey method for comparing a family of 5 estimates</code></pre>
<p>Who is above and below the overall average?</p>
<pre class="r"><code>lm_airlines %&gt;%
  emmeans(eff ~ name)</code></pre>
<pre><code>## $emmeans
##  name                     emmean   SE  df lower.CL upper.CL
##  American Airlines Inc.    183.1 8.37 487      167      200
##  Delta Air Lines Inc.      169.2 8.29 487      153      185
##  ExpressJet Airlines Inc.   98.4 8.37 487       82      115
##  JetBlue Airways           166.7 8.29 487      150      183
##  United Air Lines Inc.     206.4 8.24 487      190      223
## 
## Confidence level used: 0.95 
## 
## $contrasts
##  contrast                        estimate   SE  df t.ratio p.value
##  American Airlines Inc. effect      18.34 7.47 487  2.454  0.0241 
##  Delta Air Lines Inc. effect         4.40 7.42 487  0.594  0.6913 
##  ExpressJet Airlines Inc. effect   -66.34 7.47 487 -8.876  &lt;.0001 
##  JetBlue Airways effect              1.98 7.42 487  0.267  0.7898 
##  United Air Lines Inc. effect       41.61 7.39 487  5.632  &lt;.0001 
## 
## P value adjustment: fdr method for 5 tests</code></pre>
<p>You can find more (or even create your own) by checking out</p>
<pre class="r"><code>help(&quot;contrast-methods&quot;)</code></pre>
</div>
</div>
<div id="ordered-and-time-factors" class="section level2">
<h2>Ordered and time factors</h2>
<p>Another useful function of emmeans (and contrasts)
is when you have ordered factors, based on time or sequence.</p>
<p>Let’s use an example from another nycflights13 dataset:</p>
<pre class="r"><code>planes &lt;- nycflights13::planes %&gt;%
  filter(year &gt; 2003) %&gt;%
  mutate(across(year, as.factor))</code></pre>
<p>We can explore the differences using methods from the last section:</p>
<pre class="r"><code>planes %&gt;%
  group_by(year) %&gt;%
  summarise(across(seats, mean, na.rm = TRUE), n = n()) %&gt;%
  arrange(desc(year))</code></pre>
<pre><code>## # A tibble: 10 x 3
##    year  seats     n
##    &lt;fct&gt; &lt;dbl&gt; &lt;int&gt;
##  1 2013   192.    92
##  2 2012   199.    95
##  3 2011   197.    66
##  4 2010   152.    48
##  5 2009   182.    84
##  6 2008   136.   147
##  7 2007   121.   123
##  8 2006   127.   126
##  9 2005   113.   162
## 10 2004   116.   192</code></pre>
<p>We can analyze <code>year</code> as a numeric, to see if there is an overall linear trend:</p>
<pre class="r"><code>lm(seats ~ as.numeric(year), data = planes) %&gt;%
  summary()</code></pre>
<pre><code>## 
## Call:
## lm(formula = seats ~ as.numeric(year), data = planes)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -184.364  -49.364   -0.719   32.870  272.926 
## 
## Coefficients:
##                  Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)       95.6628     4.1200   23.22   &lt;2e-16 ***
## as.numeric(year)  10.4112     0.7515   13.85   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 74.01 on 1133 degrees of freedom
## Multiple R-squared:  0.1449, Adjusted R-squared:  0.1441 
## F-statistic: 191.9 on 1 and 1133 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>But often the business cares about differences between years.
If there was a major change in one year,
do we see that effect manifest as a statistically significant difference in later years?</p>
<p>Another example is onboarding: how do usability ratings by user
change after the user has been on the platform 1 year, compared to 2 or 3?</p>
<pre class="r"><code>lm_seats &lt;- lm(seats ~ year, data = planes)</code></pre>
<p>First, let’s look at the differences between consecutive years:</p>
<pre class="r"><code>lm_seats %&gt;%
  emmeans(consec ~ year)</code></pre>
<pre><code>## $emmeans
##  year emmean    SE   df lower.CL upper.CL
##  2004    116  5.29 1125      106      126
##  2005    113  5.76 1125      101      124
##  2006    127  6.53 1125      114      140
##  2007    121  6.61 1125      108      134
##  2008    136  6.04 1125      124      147
##  2009    182  7.99 1125      166      197
##  2010    152 10.57 1125      132      173
##  2011    197  9.02 1125      179      214
##  2012    199  7.52 1125      184      213
##  2013    192  7.64 1125      177      207
## 
## Confidence level used: 0.95 
## 
## $contrasts
##  contrast    estimate    SE   df t.ratio p.value
##  2005 - 2004    -3.48  7.82 1125 -0.445  0.9997 
##  2006 - 2005    14.34  8.70 1125  1.648  0.5509 
##  2007 - 2006    -5.65  9.29 1125 -0.608  0.9972 
##  2008 - 2007    14.29  8.95 1125  1.596  0.5903 
##  2009 - 2008    46.18 10.02 1125  4.609  &lt;.0001 
##  2010 - 2009   -29.39 13.25 1125 -2.217  0.1957 
##  2011 - 2010    44.23 13.90 1125  3.183  0.0129 
##  2012 - 2011     1.98 11.74 1125  0.169  1.0000 
##  2013 - 2012    -6.69 10.72 1125 -0.624  0.9966 
## 
## P value adjustment: mvt method for 9 tests</code></pre>
<p>We see significant differences from the year prior in 2009 and in 2011.</p>
<p>Another way to compare years is comparing the differences in means
before and after each date:</p>
<pre class="r"><code>lm_seats %&gt;%
  emmeans(mean_chg ~ year)</code></pre>
<pre><code>## $emmeans
##  year emmean    SE   df lower.CL upper.CL
##  2004    116  5.29 1125      106      126
##  2005    113  5.76 1125      101      124
##  2006    127  6.53 1125      114      140
##  2007    121  6.61 1125      108      134
##  2008    136  6.04 1125      124      147
##  2009    182  7.99 1125      166      197
##  2010    152 10.57 1125      132      173
##  2011    197  9.02 1125      179      214
##  2012    199  7.52 1125      184      213
##  2013    192  7.64 1125      177      207
## 
## Confidence level used: 0.95 
## 
## $contrasts
##  contrast  estimate   SE   df t.ratio p.value
##  2004|2005     41.4 5.87 1125  7.059  &lt;.0001 
##  2005|2006     48.8 4.80 1125 10.175  &lt;.0001 
##  2006|2007     49.8 4.55 1125 10.926  &lt;.0001 
##  2007|2008     56.9 4.53 1125 12.554  &lt;.0001 
##  2008|2009     61.7 4.71 1125 13.098  &lt;.0001 
##  2009|2010     52.5 5.11 1125 10.269  &lt;.0001 
##  2010|2011     60.5 5.40 1125 11.203  &lt;.0001 
##  2011|2012     52.3 5.97 1125  8.773  &lt;.0001 
##  2012|2013     42.8 8.03 1125  5.331  &lt;.0001 
## 
## P value adjustment: mvt method for 9 tests</code></pre>
<p>So each row is saying, for example, the difference in mean
from 2004 - 2009 and 2010 - 2013 is 52.5 seats.</p>
<p>d</p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>
<a href="http://www.clayford.net/statistics/tag/sum-contrasts/" class="uri">http://www.clayford.net/statistics/tag/sum-contrasts/</a>
<a href="https://www.r-bloggers.com/using-and-interpreting-different-contrasts-in-linear-models-in-r/" class="uri">https://www.r-bloggers.com/using-and-interpreting-different-contrasts-in-linear-models-in-r/</a>
<a href="https://blogs.uoregon.edu/rclub/2015/11/03/anova-contrasts-in-r/" class="uri">https://blogs.uoregon.edu/rclub/2015/11/03/anova-contrasts-in-r/</a><a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
