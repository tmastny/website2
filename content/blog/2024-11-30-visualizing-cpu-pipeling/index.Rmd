---
title: 'Visualizing CPU Pipeling'
author: ~
date: '2024-11-30'
slug: visualizing-cpu-pipeling
categories: []
tags: []
description: 'Visualizing CPU Pipeling'
output:
  blogdown::html_page:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, message = FALSE,
  results = "show", cache = FALSE, autodep = FALSE, error = TRUE
)
```

Visualizing CPU Pipelining.

```{=html}
<div class="pipeline-container">
  <canvas id="pipelineCanvas"></canvas>
</div>

<style>
.pipeline-container {
  width: 100%;
  max-width: 850px;
  margin: 2em auto;
}

#pipelineCanvas {
  width: 100%;
  height: auto;
  border: 1px solid #eee;
}
</style>

<script>
// Create visualization after DOM loads
document.addEventListener('DOMContentLoaded', function() {
  const canvas = document.getElementById('pipelineCanvas');
  const ctx = canvas.getContext('2d');
  
  // Constants for drawing
  const STAGE_WIDTH = 80;
  const STAGE_HEIGHT = 40;
  const STAGE_GAP = 10;
  const INSTRUCTION_GAP = 10;
  const COLORS = {
    IF: '#e6f3ff',
    ID: '#ccebff',
    EX: '#99d6ff',
    MEM: '#66c2ff',
    WB: '#33adff'
  };
  
  const instructions = [
    {name: 'add $t1', stages: []},
    {name: 'sub $t2', stages: []},
    {name: 'lw $t3', stages: []},
    {name: 'add $t5', stages: []},
    {name: 'and $t4', stages: []}
  ];
  
  function drawStage(x, y, stage) {
    ctx.fillStyle = COLORS[stage];
    ctx.strokeStyle = '#666';
    ctx.lineWidth = 1;
    
    ctx.fillRect(x, y, STAGE_WIDTH, STAGE_HEIGHT);
    ctx.strokeRect(x, y, STAGE_WIDTH, STAGE_HEIGHT);
    
    ctx.fillStyle = '#000';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(stage, x + STAGE_WIDTH/2, y + STAGE_HEIGHT/2);
  }
  
  let currentCycle = 0;
  const maxCycles = 9;
  
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw cycle numbers
    ctx.fillStyle = '#000';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    for(let i = 0; i < maxCycles; i++) {
      ctx.fillText(`Cycle ${i+1}`, 50 + i * (STAGE_WIDTH + STAGE_GAP), 20);
    }
    
    // Draw instruction names
    ctx.textAlign = 'right';
    for(let i = 0; i < instructions.length; i++) {
      ctx.fillText(instructions[i].name, 
        40, 
        50 + i * (STAGE_HEIGHT + INSTRUCTION_GAP));
    }
    
    // Draw stages up to current cycle
    if(currentCycle >= 0) {
      for(let cycle = 0; cycle <= currentCycle; cycle++) {
        for(let i = 0; i < instructions.length; i++) {
          if(cycle >= i && cycle < i + 5) { // 5 stages
            const stage = ['IF', 'ID', 'EX', 'MEM', 'WB'][cycle - i];
            drawStage(
              50 + cycle * (STAGE_WIDTH + STAGE_GAP),
              50 + i * (STAGE_HEIGHT + INSTRUCTION_GAP),
              stage
            );
          }
        }
      }
    }
  }
  
  function animate() {
    if(currentCycle < maxCycles) {
      currentCycle++;
      draw();
      setTimeout(animate, 1000); // 1 second per cycle
    }
  }
  
  // Set canvas size
  canvas.width = 850;  // Adjust based on your blog width
  canvas.height = 400;
  
  // Start animation
  animate();
});
</script>
```

```{=html}
<div class="pipeline-visualization">
  <div class="timeline">
    <div class="cycle">1</div>
    <div class="cycle">2</div>
    <div class="cycle">3</div>
    <div class="cycle">4</div>
    <div class="cycle">5</div>
    <div class="cycle">6</div>
    <div class="cycle">7</div>
    <div class="cycle">8</div>
  </div>
  
  <div class="instruction-row" style="--row: 0">
    <div class="instruction-name">add $t1</div>
    <div class="stages">
      <div class="stage if">IF</div>
      <div class="stage id">ID</div>
      <div class="stage ex">EX</div>
      <div class="stage mem">M</div>
      <div class="stage wb">WB</div>
    </div>
  </div>
  
  <div class="instruction-row" style="--row: 1">
    <div class="instruction-name">sub $t2</div>
    <div class="stages">
      <div class="stage if">IF</div>
      <div class="stage id">ID</div>
      <div class="stage ex">EX</div>
      <div class="stage mem">M</div>
      <div class="stage wb">WB</div>
    </div>
  </div>
  
  <div class="instruction-row" style="--row: 2">
    <div class="instruction-name">lw $t3</div>
    <div class="stages">
      <div class="stage if">IF</div>
      <div class="stage id">ID</div>
      <div class="stage ex">EX</div>
      <div class="stage mem">M</div>
      <div class="stage wb">WB</div>
    </div>
  </div>
  
  <div class="instruction-row" style="--row: 3">
    <div class="instruction-name">add $t5</div>
    <div class="stages">
      <div class="stage if">IF</div>
      <div class="stage id">ID</div>
      <div class="stage ex">EX</div>
      <div class="stage mem">M</div>
      <div class="stage wb">WB</div>
    </div>
  </div>
  
  <div class="instruction-row" style="--row: 4">
    <div class="instruction-name">and $t4</div>
    <div class="stages">
      <div class="stage if">IF</div>
      <div class="stage id">ID</div>
      <div class="stage ex">EX</div>
      <div class="stage mem">M</div>
      <div class="stage wb">WB</div>
    </div>
  </div>
</div>

<style>
.pipeline-visualization {
  font-family: monospace;
  margin: 2em 0;
}

.timeline {
  display: grid;
  grid-template-columns: 100px repeat(8, 60px);
  gap: 4px;
  margin-bottom: 1em;
}

.cycle {
  text-align: center;
  font-size: 0.9em;
  color: #666;
}

.instruction-row {
  display: grid;
  grid-template-columns: 100px auto;
  margin-bottom: 4px;
}

.instruction-name {
  padding: 4px;
}

.stages {
  display: grid;
  grid-template-columns: repeat(8, 60px);
  gap: 4px;
}

.stage {
  padding: 4px;
  text-align: center;
  font-size: 0.9em;
  opacity: 0;
  animation: fadeIn 0.5s forwards;
  background: #e6f3ff;
  border: 1px solid #ccc;
}

/* Different colors for each stage */
.stage.if { background: #e6f3ff; animation-delay: calc(var(--row) * 1s); }
.stage.id { background: #ccebff; animation-delay: calc((var(--row) * 1s) + 1s); }
.stage.ex { background: #99d6ff; animation-delay: calc((var(--row) * 1s) + 2s); }
.stage.mem { background: #66c2ff; animation-delay: calc((var(--row) * 1s) + 3s); }
.stage.wb { background: #33adff; animation-delay: calc((var(--row) * 1s) + 4s); }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>
```


```{r}
instructions <- c("add $t1", "sub $t2", "lw $t3", "add $t5", "and $t4")
stages <- c("IF", "ID", "EX", "MEM", "WB")
colors <- c("#e6f3ff", "#ccebff", "#99d6ff", "#66c2ff", "#33adff")

# Generate instruction text elements
generate_instruction_text <- function(instructions) {
  text_elements <- character(length(instructions))
  for(i in seq_along(instructions)) {
    y_pos <- 70 + (i-1)*50
    text_elements[i] <- sprintf('<text x="80" y="%d">%s</text>', 
                              y_pos, instructions[i])
  }
  paste(text_elements, collapse="\n")
}

# Generate stage rectangles and text for each instruction
# Now with proper cycle alignment
generate_stages <- function(instructions) {
  all_elements <- character(length(instructions))
  
  for(i in seq_along(instructions)) {
    y_base <- 50 + (i-1)*50
    stage_elements <- character(length(stages))
    
    for(j in seq_along(stages)) {
      # Each instruction starts one cycle later than the previous
      # and each stage is one cycle after the previous stage
      x_base <- 100 + (i-1)*100 + (j-1)*100
      delay <- (i-1)*0.2 + (j-1)*0.2
      
      rect <- sprintf(
        '<rect class="stage %s" x="%d" y="%d" width="80" height="30" rx="2" style="animation-delay: %ss"/>',
        tolower(stages[j]), x_base, y_base, delay
      )
      text <- sprintf(
        '<text x="%d" y="%d">%s</text>',
        x_base + 40, y_base + 20, stages[j]
      )
      stage_elements[j] <- paste(rect, text)
    }
    all_elements[i] <- paste(stage_elements, collapse="\n")
  }
  paste(all_elements, collapse="\n")
}

# Generate cycle numbers
generate_cycles <- function(n_cycles=8) {
  cycle_texts <- character(n_cycles)
  for(i in seq_len(n_cycles)) {
    x_pos <- 100 + (i-1)*100
    cycle_texts[i] <- sprintf('<text x="%d" y="30">Cycle %d</text>', 
                            x_pos, i)
  }
  paste(cycle_texts, collapse="\n")
}
```


```{=html}
<div class="pipeline-container">
  <button onclick="resetAnimation()" class="reset-button">Reset Animation</button>
  <svg viewBox="0 0 900 300" style="width: 100%; height: auto;">
    <!-- Cycle numbers -->
    <g class="cycles" font-size="14" dominant-baseline="hanging">
      `r generate_cycles()`
    </g>

    <!-- Instructions -->
    <g class="instructions" font-size="14" text-anchor="end" dominant-baseline="middle">
      `r generate_instruction_text(instructions)`
    </g>

    <!-- Pipeline stages -->
    <g class="stages" font-size="12" text-anchor="middle" dominant-baseline="middle">
      `r generate_stages(instructions)`
    </g>
  </svg>
</div>

<style>
.pipeline-container {
  margin: 2em 0;
  border: 1px solid #eee;
  padding: 1em;
  position: relative;
}

.reset-button {
  position: absolute;
  top: 10px;
  right: 10px;
  padding: 5px 10px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  cursor: pointer;
}

.reset-button:hover {
  background: #e9ecef;
}

.stage {
  fill: #e6f3ff;
  stroke: #ccc;
  stroke-width: 1;
  opacity: 0;
}

text {
  font-family: monospace;
}

.stage {
  animation: fadeIn 0.3s forwards;
}

/* Different blue shades for stages */
.stage.if { fill: #e6f3ff; }
.stage.id { fill: #ccebff; }
.stage.ex { fill: #99d6ff; }
.stage.mem { fill: #66c2ff; }
.stage.wb { fill: #33adff; }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>

<script>
function resetAnimation() {
  const stages = document.querySelectorAll('.stage');
  stages.forEach(stage => {
    stage.style.animation = 'none';
    stage.offsetHeight; // Trigger reflow
    stage.style.animation = null;
  });
}
</script>
```